{% extends 'base.html' %}
{% block title %}Admin Home Page{% endblock %}

{% block content %}
{% load humanize %}
{% if user.is_authenticated and user.is_staff and user.is_superuser %}

<div class="container">
    {% include 'topside.html' %}
    <div>

    <div class="chart-select">
        <label for="chartType">Select Chart Type:</label>
        <select id="chartType" onchange="updateChart()">
            <option value="waterfall">Waterfall Chart</option>
            <option value="bar">Bar Chart</option>
            <option value="pie">Pie Chart</option>
            <option value="gantt">Gantt Chart</option>
            <option value="flowchart">Flowchart</option>
            <option value="radar">Radar Chart</option>
        </select>
    </div>

    <div id="chartContainer"></div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        function updateChart() {
            var chartType = document.getElementById('chartType').value;
            var chartContainer = document.getElementById('chartContainer');

            // Clear previous chart
            chartContainer.innerHTML = '';

            // Fetch data from Django context (this can be dynamic data from the backend)
            var data = {
                product_count: {{ product_count }},
                total_buy_price: {{ total_buy_price }},
                total_sell_price: {{ total_sell_price }},
                total_order_price: {{ total_order_price }},
                total_transactions: {{ total_transactions }}
            };

            // Define chart data and layout based on selected chart type
            var chartData, layout;

            if (chartType === 'waterfall') {
                chartData = [{
                    type: 'waterfall',
                    x: ['Product Buy Price', 'Product Sell Price', 'Order Price'],
                    y: [data.total_buy_price, data.total_sell_price, data.total_order_price],
                    decreasing: {marker: {color: 'Maroon', line: {color: 'red', width: 2}}},
                    increasing: {marker: {color: 'Teal'}},
                    totals: {marker: {color: 'DeepSkyBlue', line: {color: 'blue', width: 3}}}
                }];
                layout = { title: 'Waterfall Chart' };
            } else if (chartType === 'bar') {
                chartData = [{
                    x: ['Products', 'Orders', 'Transactions'],
                    y: [data.product_count, data.total_order_price, data.total_transactions],
                    type: 'bar'
                }];
                layout = { title: 'Bar Chart' };
            } else if (chartType === 'pie') {
                chartData = [{
                    labels: ['Products', 'Orders', 'Transactions'],
                    values: [data.product_count, data.total_order_price, data.total_transactions],
                    type: 'pie'
                }];
                layout = { title: 'Pie Chart' };
            } else if (chartType === 'gantt') {
                chartData = [{
                    type: 'bar',
                    x: [data.total_buy_price, data.total_sell_price, data.total_order_price],
                    y: ['Buy Price', 'Sell Price', 'Order Price'],
                    orientation: 'h'
                }];
                layout = { title: 'Gantt Chart' };
            } else if (chartType === 'flowchart') {
                chartData = [{
                    type: 'sankey',
                    orientation: 'h',
                    node: {
                        pad: 15,
                        thickness: 30,
                        line: {color: 'black', width: 0.5},
                        label: ['Products', 'Orders', 'Transactions']
                    },
                    link: {
                        source: [0, 1, 0],
                        target: [1, 2, 2],
                        value: [data.product_count, data.total_order_price, data.total_transactions]
                    }
                }];
                layout = { title: 'Flowchart' };
            } else if (chartType === 'radar') {
                chartData = [{
                    type: 'scatterpolar',
                    r: [data.product_count, data.total_order_price, data.total_transactions],
                    theta: ['Products', 'Orders', 'Transactions'],
                    fill: 'toself'
                }];
                layout = { title: 'Radar Chart' };
            }

            // Render the selected chart
            Plotly.newPlot(chartContainer, chartData, layout);
        }

        // Initialize with the default chart type (Waterfall Chart)
        updateChart();
    </script>
</div>

<h2>Transactions History</h2>
<table class="table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Balance After</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        {% for transaction in transactions %}
        <tr>
            <td>{{ transaction.date }}</td>
            <td>{{ transaction.get_transaction_type_display }}</td>
            <td>{{ transaction.amount }}</td>
            <td>{{ transaction.balance_after_transaction }}</td>
            <td>{{ transaction.description }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

</div>
{% else %}

{% endif %}

{% endblock %}
